<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eternal Darkness RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 50%, #0a0520 100%);
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(139, 0, 0, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(25, 0, 51, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: rgba(20, 20, 30, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            margin-bottom: 8px;
        }

        .player-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat {
            background: rgba(30, 30, 45, 0.6);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            margin-top: 2px;
        }

        .content {
            flex: 1;
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .nav {
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 12px;
            display: flex;
            justify-content: space-around;
            gap: 5px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }

        .btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            margin: 5px 0;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            background: rgba(60, 60, 80, 0.5);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }

        .login-form h2 {
            color: #ff6b6b;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.2);
        }

        .battle-area {
            margin-bottom: 20px;
        }

        .combatants {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .combatant {
            background: rgba(30, 30, 45, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid;
            position: relative;
            overflow: hidden;
        }

        .combatant::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .combatant.player {
            border-color: #4dabf7;
        }

        .combatant.enemy {
            border-color: #ff6b6b;
        }

        .combatant-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .health-bar-container {
            background: rgba(0, 0, 0, 0.5);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .health-bar {
            height: 100%;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #ff6b6b 0%, #ff8787 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .health-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: healthShine 2s infinite;
        }

        @keyframes healthShine {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .health-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
            z-index: 1;
        }

        .battle-log {
            background: rgba(10, 10, 15, 0.9);
            padding: 15px;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'Courier New', monospace;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 8px;
            border-radius: 4px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-entry.damage {
            color: #ffa07a;
        }

        .log-entry.critical {
            color: #ff6b6b;
            font-weight: bold;
        }

        .log-entry.miss {
            color: #aaa;
        }

        .log-entry.victory {
            color: #69db7c;
            font-weight: bold;
        }

        .log-entry.defeat {
            color: #ff6b6b;
            font-weight: bold;
        }

        .item {
            background: rgba(30, 30, 45, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid;
            position: relative;
            overflow: hidden;
        }

        .item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent 30%, currentColor 50%, transparent 70%);
            opacity: 0.1;
            animation: itemGlow 3s infinite;
        }

        @keyframes itemGlow {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .item.common { border-color: #868e96; }
        .item.uncommon { border-color: #51cf66; }
        .item.rare { border-color: #339af0; }
        .item.epic { border-color: #9775fa; }
        .item.legendary { border-color: #ffd700; }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: bold;
            font-size: 16px;
        }

        .item-rarity {
            font-size: 11px;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
        }

        .item-stats {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 14px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            background: rgba(30, 30, 45, 0.8);
            color: #ffd700;
            font-size: 14px;
            text-transform: uppercase;
        }

        .leaderboard-table tr:hover {
            background: rgba(40, 40, 60, 0.5);
        }

        .rank {
            font-weight: bold;
            font-size: 18px;
        }

        .rank.top1 { color: #ffd700; }
        .rank.top2 { color: #c0c0c0; }
        .rank.top3 { color: #cd7f32; }

        .progress-bar {
            background: rgba(0, 0, 0, 0.5);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4dabf7 0%, #339af0 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .death-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .death-screen h2 {
            color: #ff6b6b;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
        }

        .death-stats {
            background: rgba(30, 30, 45, 0.8);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .meta-progress {
            background: rgba(40, 40, 60, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #888;
        }

        @media (max-width: 600px) {
            .combatants {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .player-info {
                grid-template-columns: 1fr 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="content">
                <div class="login-form">
                    <h2>‚öîÔ∏è ETERNAL DARKNESS ‚öîÔ∏è</h2>
                    <p style="margin-bottom: 30px; color: #888;">Hardcore Endless RPG</p>
                    <div class="form-group">
                        <label>–ù–∏–∫–Ω–µ–π–º</label>
                        <input type="text" id="loginNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn" onclick="game.login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">
                        –ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Game Screens -->
        <div id="gameScreens" style="display: none; flex-direction: column; height: 100vh;">
            <div class="header">
                <h1>‚öîÔ∏è Eternal Darkness</h1>
                <div class="player-info">
                    <div class="stat">
                        <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                        <div class="stat-value" id="playerLevel">1</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">HP</div>
                        <div class="stat-value" id="playerHP">100/100</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">–ê—Ç–∞–∫–∞</div>
                        <div class="stat-value" id="playerAttack">10</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">–ó–∞—â–∏—Ç–∞</div>
                        <div class="stat-value" id="playerDefense">5</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">–ó–æ–ª–æ—Ç–æ</div>
                        <div class="stat-value" id="playerGold">0</div>
                    </div>
                </div>
            </div>

            <!-- Player Screen -->
            <div id="playerScreen" class="screen">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">–ü–µ—Ä—Å–æ–Ω–∞–∂</h2>
                    <div id="playerStats"></div>
                    <div class="meta-progress">
                        <h3 style="margin-bottom: 15px;">–ú–µ—Ç–∞-–ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                        <div id="metaProgress"></div>
                    </div>
                </div>
            </div>

            <!-- Inventory Screen -->
            <div id="inventoryScreen" class="screen">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</h3>
                    <div id="equippedItems"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">–†—é–∫–∑–∞–∫</h3>
                    <div id="inventoryItems"></div>
                </div>
            </div>

            <!-- World Screen -->
            <div id="worldScreen" class="screen active">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">–ú–∏—Ä</h2>
                    <div style="background: rgba(30, 30, 45, 0.8); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3>–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è: <span id="currentLocation">–¢–µ–º–Ω—ã–π –ª–µ—Å</span></h3>
                        <p style="margin-top: 10px; color: #aaa;">–£—Ä–æ–≤–µ–Ω—å: <span id="worldLevel">1</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="worldProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <button class="btn" onclick="game.startBattle()">‚öîÔ∏è –ù–∞—á–∞—Ç—å –±–æ–π</button>
                    <button class="btn btn-secondary" onclick="game.rest()">üèïÔ∏è –û—Ç–¥–æ—Ö–Ω—É—Ç—å (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å HP)</button>
                </div>
            </div>

            <!-- Battle Screen -->
            <div id="battleScreen" class="screen">
                <div class="content">
                    <div class="battle-area">
                        <div class="combatants">
                            <div class="combatant player">
                                <div class="combatant-name" id="battlePlayerName">–ò–≥—Ä–æ–∫</div>
                                <div class="health-bar-container">
                                    <div class="health-text" id="battlePlayerHPText">100/100</div>
                                    <div class="health-bar" id="battlePlayerHP" style="width: 100%"></div>
                                </div>
                                <div style="margin-top: 10px; font-size: 13px;">
                                    <div>‚öîÔ∏è –ê—Ç–∞–∫–∞: <span id="battlePlayerAttack">10</span></div>
                                    <div>üõ°Ô∏è –ó–∞—â–∏—Ç–∞: <span id="battlePlayerDefense">5</span></div>
                                </div>
                            </div>
                            <div class="combatant enemy">
                                <div class="combatant-name" id="battleEnemyName">–í—Ä–∞–≥</div>
                                <div class="health-bar-container">
                                    <div class="health-text" id="battleEnemyHPText">50/50</div>
                                    <div class="health-bar" id="battleEnemyHP" style="width: 100%"></div>
                                </div>
                                <div style="margin-top: 10px; font-size: 13px;">
                                    <div>‚öîÔ∏è –ê—Ç–∞–∫–∞: <span id="battleEnemyAttack">8</span></div>
                                    <div>üõ°Ô∏è –ó–∞—â–∏—Ç–∞: <span id="battleEnemyDefense">3</span></div>
                                </div>
                            </div>
                        </div>
                        <button class="btn" id="attackBtn" onclick="game.playerAttack()">‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-secondary" id="fleeBtn" onclick="game.flee()">üèÉ –ë–µ–∂–∞—Ç—å</button>
                    </div>
                    <div class="battle-log" id="battleLog"></div>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div id="leaderboardScreen" class="screen">
                <div class="content">
                    <h2 style="margin-bottom: 20px;">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
                    <div id="leaderboardContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav">
                <button class="nav-btn" onclick="game.switchScreen('playerScreen')">üë§ –ò–≥—Ä–æ–∫</button>
                <button class="nav-btn" onclick="game.switchScreen('inventoryScreen')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
                <button class="nav-btn active" onclick="game.switchScreen('worldScreen')">üåç –ú–∏—Ä</button>
                <button class="nav-btn" onclick="game.switchScreen('battleScreen')">‚öîÔ∏è –ë–æ–π</button>
                <button class="nav-btn" onclick="game.switchScreen('leaderboardScreen')">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME ENGINE (IMMUTABLE CORE) ====================
        class GameEngine {
            constructor() {
                this.eventHandlers = {};
                this.extensionPoints = {
                    beforeBattle: [],
                    afterBattle: [],
                    onLevelUp: [],
                    onItemEquip: [],
                    onDamageCalculation: [],
                    onEnemyGeneration: []
                };
            }

            emit(event, data) {
                if (this.eventHandlers[event]) {
                    this.eventHandlers[event].forEach(handler => handler(data));
                }
            }

            on(event, handler) {
                if (!this.eventHandlers[event]) {
                    this.eventHandlers[event] = [];
                }
                this.eventHandlers[event].push(handler);
            }

            registerExtension(point, handler) {
                if (this.extensionPoints[point]) {
                    this.extensionPoints[point].push(handler);
                }
            }

            executeExtensions(point, data) {
                if (this.extensionPoints[point]) {
                    this.extensionPoints[point].forEach(handler => handler(data));
                }
                return data;
            }

            random(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            randomFloat(min, max) {
                return Math.random() * (max - min) + min;
            }

            rollCritical(critChance = 0.15) {
                return Math.random() < critChance;
            }

            rollMiss(missChance = 0.1) {
                return Math.random() < missChance;
            }

            calculateScaling(baseValue, level, scalingFactor = 1.1) {
                return Math.floor(baseValue * Math.pow(scalingFactor, level - 1));
            }
        }

        // ==================== DATA REGISTRY (EXTENSIBLE CONTENT) ====================
        const GameData = {
            rarities: {
                common: { name: '–û–±—ã—á–Ω—ã–π', color: '#868e96', statMult: 1.0, dropChance: 0.50 },
                uncommon: { name: '–ù–µ–æ–±—ã—á–Ω—ã–π', color: '#51cf66', statMult: 1.3, dropChance: 0.30 },
                rare: { name: '–†–µ–¥–∫–∏–π', color: '#339af0', statMult: 1.7, dropChance: 0.15 },
                epic: { name: '–≠–ø–∏—á–µ—Å–∫–∏–π', color: '#9775fa', statMult: 2.2, dropChance: 0.04 },
                legendary: { name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', color: '#ffd700', statMult: 3.0, dropChance: 0.01 }
            },

            weapons: [
                { name: '–†–∂–∞–≤—ã–π –º–µ—á', baseAttack: 5, levelReq: 1 },
                { name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', baseAttack: 10, levelReq: 5 },
                { name: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', baseAttack: 20, levelReq: 10 },
                { name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤—ã–π –º–µ—á', baseAttack: 35, levelReq: 20 },
                { name: '–ê–¥–∞–º–∞–Ω—Ç–∏—Ç–æ–≤—ã–π –º–µ—á', baseAttack: 60, levelReq: 40 },
                { name: '–î—Ä–∞–∫–æ–Ω–∏–π –∫–ª–∏–Ω–æ–∫', baseAttack: 100, levelReq: 70 },
                { name: '–ö–ª–∏–Ω–æ–∫ –ë–µ–∑–¥–Ω—ã', baseAttack: 180, levelReq: 120 },
                { name: '–ú–µ—á –í–µ—á–Ω–æ—Å—Ç–∏', baseAttack: 320, levelReq: 200 },
                { name: '–ë–æ–µ–≤–æ–π —Ç–æ–ø–æ—Ä', baseAttack: 8, levelReq: 3 },
                { name: '–í–µ–ª–∏–∫–∏–π —Ç–æ–ø–æ—Ä', baseAttack: 45, levelReq: 35 },
                { name: '–ü–æ—Å–æ—Ö —Ç—å–º—ã', baseAttack: 25, levelReq: 15 },
                { name: '–ü–æ—Å–æ—Ö —Ö–∞–æ—Å–∞', baseAttack: 150, levelReq: 100 },
                { name: '–ö–∏–Ω–∂–∞–ª —Ç–µ–Ω–∏', baseAttack: 12, levelReq: 7 },
                { name: '–ö–ª–∏–Ω–æ–∫ —É–±–∏–π—Ü—ã', baseAttack: 85, levelReq: 60 }
            ],

            armor: [
                { name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', baseDefense: 3, levelReq: 1 },
                { name: '–ñ–µ–ª–µ–∑–Ω–∞—è –±—Ä–æ–Ω—è', baseDefense: 7, levelReq: 5 },
                { name: '–°—Ç–∞–ª—å–Ω–∞—è –±—Ä–æ–Ω—è', baseDefense: 15, levelReq: 10 },
                { name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è –±—Ä–æ–Ω—è', baseDefense: 25, levelReq: 20 },
                { name: '–ê–¥–∞–º–∞–Ω—Ç–∏—Ç–æ–≤–∞—è –±—Ä–æ–Ω—è', baseDefense: 45, levelReq: 40 },
                { name: '–î—Ä–∞–∫–æ–Ω—å—è –±—Ä–æ–Ω—è', baseDefense: 80, levelReq: 70 },
                { name: '–ë—Ä–æ–Ω—è –ë–µ–∑–¥–Ω—ã', baseDefense: 140, levelReq: 120 },
                { name: '–ë—Ä–æ–Ω—è –í–µ—á–Ω–æ—Å—Ç–∏', baseDefense: 250, levelReq: 200 },
                { name: '–ö–æ–ª—å—á—É–≥–∞', baseDefense: 10, levelReq: 8 },
                { name: '–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–µ –¥–æ—Å–ø–µ—Ö–∏', baseDefense: 55, levelReq: 50 }
            ],

            enemies: [
                { name: '–ì–æ–±–ª–∏–Ω', baseHP: 30, baseAttack: 5, baseDef: 2 },
                { name: '–û—Ä–∫', baseHP: 50, baseAttack: 8, baseDef: 4 },
                { name: '–¢—Ä–æ–ª–ª—å', baseHP: 80, baseAttack: 12, baseDef: 6 },
                { name: '–¢–µ–º–Ω—ã–π —Ä—ã—Ü–∞—Ä—å', baseHP: 100, baseAttack: 15, baseDef: 10 },
                { name: '–î–µ–º–æ–Ω', baseHP: 150, baseAttack: 20, baseDef: 12 },
                { name: '–î—Ä–∞–∫–æ–Ω', baseHP: 250, baseAttack: 30, baseDef: 18 },
                { name: '–î—Ä–µ–≤–Ω–µ–µ –∑–ª–æ', baseHP: 400, baseAttack: 45, baseDef: 25 },
                { name: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å —Ç—å–º—ã', baseHP: 600, baseAttack: 65, baseDef: 35 },
                { name: '–°–∫–µ–ª–µ—Ç', baseHP: 25, baseAttack: 6, baseDef: 3 },
                { name: '–ó–æ–º–±–∏', baseHP: 40, baseAttack: 7, baseDef: 5 },
                { name: '–í–∞–º–ø–∏—Ä', baseHP: 120, baseAttack: 18, baseDef: 8 },
                { name: '–õ–∏—á', baseHP: 200, baseAttack: 35, baseDef: 20 },
                { name: '–•–∏–º–µ—Ä–∞', baseHP: 180, baseAttack: 28, baseDef: 15 },
                { name: '–ì–∏–¥—Ä–∞', baseHP: 300, baseAttack: 40, baseDef: 22 }
            ],

            locations: [
                { name: '–¢–µ–º–Ω—ã–π –ª–µ—Å', minLevel: 1 },
                { name: '–ó–∞–±—ã—Ç—ã–µ —Ä—É–∏–Ω—ã', minLevel: 20 },
                { name: '–ü—Ä–æ–∫–ª—è—Ç—ã–µ –±–æ–ª–æ—Ç–∞', minLevel: 50 },
                { name: '–û–≥–Ω–µ–Ω–Ω—ã–µ –ø–µ—â–µ—Ä—ã', minLevel: 100 },
                { name: '–õ–µ–¥—è–Ω–∞—è —Ü–∏—Ç–∞–¥–µ–ª—å', minLevel: 200 },
                { name: '–ë–µ–∑–¥–Ω–∞ —Ö–∞–æ—Å–∞', minLevel: 400 },
                { name: '–í—Ä–∞—Ç–∞ –≤–µ—á–Ω–æ—Å—Ç–∏', minLevel: 700 },
                { name: '–ö—Ä–∞–π –º–∏—Ä–æ–∑–¥–∞–Ω–∏—è', minLevel: 1000 }
            ]
        };

        // ==================== GAME LOGIC ====================
        class Game {
            constructor() {
                this.engine = new GameEngine();
                this.player = null;
                this.currentEnemy = null;
                this.battleLog = [];
                this.inBattle = false;
                this.supabaseUrl = 'https://tlkzgponxbnvxdaxqcsf.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsa3pncG9ueGJudnhkYXhxY3NmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTg5NjEsImV4cCI6MjA4NTQzNDk2MX0.y7qVxfksrtNfhBeze1xUIQKeriMVFUtAiABrQ8UyJNs';
                
                this.initializeSupabase();
            }

            async initializeSupabase() {
                // Create leaderboard table if it doesn't exist
                try {
                    await this.supabaseFetch('/rest/v1/leaderboard?select=*&limit=1', 'GET');
                } catch (e) {
                    console.log('Leaderboard table might need to be created manually in Supabase dashboard');
                }
            }

            async supabaseFetch(endpoint, method = 'GET', body = null) {
                const options = {
                    method,
                    headers: {
                        'apikey': this.supabaseKey,
                        'Authorization': `Bearer ${this.supabaseKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(this.supabaseUrl + endpoint, options);
                if (!response.ok && response.status !== 409) {
                    throw new Error(`Supabase error: ${response.status}`);
                }
                return response.json();
            }

            login() {
                const nickname = document.getElementById('loginNickname').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!nickname || !password) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                    return;
                }

                const savedData = localStorage.getItem('eternalDarknessPlayer');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.nickname === nickname && data.password === password) {
                        this.loadPlayer(data);
                    } else if (data.nickname === nickname) {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                        return;
                    } else {
                        alert('–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ —Å–æ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.');
                        return;
                    }
                } else {
                    this.createPlayer(nickname, password);
                }

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreens').style.display = 'flex';
                this.updateUI();
            }

            createPlayer(nickname, password) {
                this.player = {
                    nickname,
                    password,
                    level: 1,
                    xp: 0,
                    xpToNext: 100,
                    maxHP: 100,
                    currentHP: 100,
                    baseAttack: 10,
                    baseDefense: 5,
                    gold: 0,
                    inventory: [],
                    equipped: { weapon: null, armor: null },
                    highestLevel: 1,
                    totalKills: 0,
                    totalDeaths: 0,
                    metaPoints: 0,
                    metaBonus: { attack: 0, defense: 0, hp: 0 }
                };
                this.savePlayer();
            }

            loadPlayer(data) {
                this.player = data;
                // Ensure all properties exist
                this.player.metaPoints = this.player.metaPoints || 0;
                this.player.metaBonus = this.player.metaBonus || { attack: 0, defense: 0, hp: 0 };
                this.player.totalKills = this.player.totalKills || 0;
                this.player.totalDeaths = this.player.totalDeaths || 0;
            }

            savePlayer() {
                localStorage.setItem('eternalDarknessPlayer', JSON.stringify(this.player));
            }

            async updateLeaderboard() {
                try {
                    const data = {
                        nickname: this.player.nickname,
                        highest_level: this.player.highestLevel,
                        updated_at: new Date().toISOString()
                    };

                    await this.supabaseFetch('/rest/v1/leaderboard', 'POST', data);
                } catch (e) {
                    console.log('Could not update leaderboard:', e);
                }
            }

            async loadLeaderboard() {
                try {
                    const data = await this.supabaseFetch('/rest/v1/leaderboard?select=*&order=highest_level.desc&limit=10', 'GET');
                    
                    let html = '<table class="leaderboard-table"><thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–≥—Ä–æ–∫</th><th>–£—Ä–æ–≤–µ–Ω—å</th></tr></thead><tbody>';
                    
                    if (data && data.length > 0) {
                        data.forEach((entry, index) => {
                            const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
                            html += `<tr>
                                <td class="rank ${rankClass}">${index + 1}</td>
                                <td>${entry.nickname}</td>
                                <td>${entry.highest_level}</td>
                            </tr>`;
                        });
                    } else {
                        html += '<tr><td colspan="3" style="text-align: center; color: #888;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                    }
                    
                    html += '</tbody></table>';
                    document.getElementById('leaderboardContent').innerHTML = html;
                } catch (e) {
                    document.getElementById('leaderboardContent').innerHTML = 
                        '<p style="text-align: center; color: #888;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</p>';
                }
            }

            switchScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                
                document.getElementById(screenId).classList.add('active');
                event.target.classList.add('active');

                if (screenId === 'playerScreen') this.updatePlayerScreen();
                if (screenId === 'inventoryScreen') this.updateInventoryScreen();
                if (screenId === 'worldScreen') this.updateWorldScreen();
                if (screenId === 'leaderboardScreen') this.loadLeaderboard();
            }

            updateUI() {
                document.getElementById('playerLevel').textContent = this.player.level;
                document.getElementById('playerHP').textContent = `${this.player.currentHP}/${this.player.maxHP}`;
                document.getElementById('playerAttack').textContent = this.getTotalAttack();
                document.getElementById('playerDefense').textContent = this.getTotalDefense();
                document.getElementById('playerGold').textContent = this.player.gold;
            }

            updatePlayerScreen() {
                const stats = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="stat">
                            <div class="stat-label">–û–ø—ã—Ç</div>
                            <div class="stat-value">${this.player.xp} / ${this.player.xpToNext}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">–£–±–∏–π—Å—Ç–≤</div>
                            <div class="stat-value">${this.player.totalKills}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">–°–º–µ—Ä—Ç–µ–π</div>
                            <div class="stat-value">${this.player.totalDeaths}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">–õ—É—á—à–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
                            <div class="stat-value">${this.player.highestLevel}</div>
                        </div>
                    </div>
                `;
                document.getElementById('playerStats').innerHTML = stats;

                const meta = `
                    <div style="font-size: 14px;">
                        <p style="margin-bottom: 10px;">–û—á–∫–∏ –º–µ—Ç–∞-–ø—Ä–æ–≥—Ä–µ—Å—Å–∞: <strong style="color: #ffd700;">${this.player.metaPoints}</strong></p>
                        <p style="color: #888; font-size: 12px; margin-bottom: 15px;">–ü–æ–ª—É—á–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–º–µ—Ä—Ç–∏. –î–∞—é—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã.</p>
                        <div style="display: grid; gap: 10px;">
                            <div class="stat">
                                <div class="stat-label">–ë–æ–Ω—É—Å –∞—Ç–∞–∫–∏</div>
                                <div class="stat-value">+${this.player.metaBonus.attack}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–ë–æ–Ω—É—Å –∑–∞—â–∏—Ç—ã</div>
                                <div class="stat-value">+${this.player.metaBonus.defense}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–ë–æ–Ω—É—Å HP</div>
                                <div class="stat-value">+${this.player.metaBonus.hp}</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('metaProgress').innerHTML = meta;
            }

            updateInventoryScreen() {
                let equippedHTML = '<p style="color: #888; margin: 10px 0;">–ü—É—Å—Ç–æ</p>';
                
                if (this.player.equipped.weapon || this.player.equipped.armor) {
                    equippedHTML = '';
                    if (this.player.equipped.weapon) {
                        equippedHTML += this.renderItem(this.player.equipped.weapon, 'weapon');
                    }
                    if (this.player.equipped.armor) {
                        equippedHTML += this.renderItem(this.player.equipped.armor, 'armor');
                    }
                }
                
                document.getElementById('equippedItems').innerHTML = equippedHTML;

                let inventoryHTML = '';
                if (this.player.inventory.length === 0) {
                    inventoryHTML = '<p style="color: #888; margin: 10px 0;">–ü—É—Å—Ç–æ</p>';
                } else {
                    this.player.inventory.forEach((item, index) => {
                        inventoryHTML += this.renderItem(item, null, index);
                    });
                }
                
                document.getElementById('inventoryItems').innerHTML = inventoryHTML;
            }

            renderItem(item, slot, invIndex = null) {
                const isEquipped = slot !== null;
                const buttonText = isEquipped ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å';
                const action = isEquipped ? 
                    `game.unequipItem('${slot}')` : 
                    `game.equipItem(${invIndex})`;

                return `
                    <div class="item ${item.rarity}">
                        <div class="item-header">
                            <div class="item-name">${item.name}</div>
                            <div class="item-rarity" style="color: ${GameData.rarities[item.rarity].color}">
                                ${GameData.rarities[item.rarity].name}
                            </div>
                        </div>
                        <div class="item-stats">
                            ${item.attack ? `<span>‚öîÔ∏è –ê—Ç–∞–∫–∞: +${item.attack}</span>` : ''}
                            ${item.defense ? `<span>üõ°Ô∏è –ó–∞—â–∏—Ç–∞: +${item.defense}</span>` : ''}
                        </div>
                        <button class="btn" style="margin-top: 10px;" onclick="${action}">${buttonText}</button>
                    </div>
                `;
            }

            equipItem(index) {
                const item = this.player.inventory[index];
                const slot = item.attack ? 'weapon' : 'armor';

                if (this.player.equipped[slot]) {
                    this.player.inventory.push(this.player.equipped[slot]);
                }

                this.player.equipped[slot] = item;
                this.player.inventory.splice(index, 1);
                
                this.savePlayer();
                this.updateUI();
                this.updateInventoryScreen();
                this.engine.executeExtensions('onItemEquip', { item, slot });
            }

            unequipItem(slot) {
                this.player.inventory.push(this.player.equipped[slot]);
                this.player.equipped[slot] = null;
                
                this.savePlayer();
                this.updateUI();
                this.updateInventoryScreen();
            }

            updateWorldScreen() {
                const location = this.getCurrentLocation();
                document.getElementById('currentLocation').textContent = location.name;
                document.getElementById('worldLevel').textContent = this.player.level;
                
                const progress = (this.player.xp / this.player.xpToNext) * 100;
                document.getElementById('worldProgress').style.width = progress + '%';
                document.getElementById('worldProgress').textContent = Math.floor(progress) + '%';
            }

            getCurrentLocation() {
                for (let i = GameData.locations.length - 1; i >= 0; i--) {
                    if (this.player.level >= GameData.locations[i].minLevel) {
                        return GameData.locations[i];
                    }
                }
                return GameData.locations[0];
            }

            getTotalAttack() {
                let total = this.player.baseAttack + this.player.metaBonus.attack;
                if (this.player.equipped.weapon) {
                    total += this.player.equipped.weapon.attack;
                }
                return total;
            }

            getTotalDefense() {
                let total = this.player.baseDefense + this.player.metaBonus.defense;
                if (this.player.equipped.armor) {
                    total += this.player.equipped.armor.defense;
                }
                return total;
            }

            rest() {
                this.player.currentHP = this.player.maxHP;
                this.savePlayer();
                this.updateUI();
                alert('–í—ã –æ—Ç–¥–æ—Ö–Ω—É–ª–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—Å–µ HP!');
            }

            startBattle() {
                if (this.inBattle) return;
                
                this.currentEnemy = this.generateEnemy();
                this.inBattle = true;
                this.battleLog = [];
                
                this.engine.executeExtensions('beforeBattle', { enemy: this.currentEnemy });
                
                this.switchScreen('battleScreen');
                this.updateBattleUI();
                this.addBattleLog(`–ù–∞—á–∞–ª–∞—Å—å –±–∏—Ç–≤–∞ —Å ${this.currentEnemy.name}!`, 'info');
            }

            generateEnemy() {
                const template = GameData.enemies[this.engine.random(0, GameData.enemies.length - 1)];
                const levelVariance = this.engine.random(-2, 5);
                const enemyLevel = Math.max(1, this.player.level + levelVariance);

                const enemy = {
                    name: template.name,
                    level: enemyLevel,
                    maxHP: this.engine.calculateScaling(template.baseHP, enemyLevel, 1.12),
                    currentHP: 0,
                    attack: this.engine.calculateScaling(template.baseAttack, enemyLevel, 1.08),
                    defense: this.engine.calculateScaling(template.baseDef, enemyLevel, 1.06)
                };
                
                enemy.currentHP = enemy.maxHP;
                
                this.engine.executeExtensions('onEnemyGeneration', enemy);
                
                return enemy;
            }

            playerAttack() {
                if (!this.inBattle) return;

                const playerDamage = this.calculateDamage(
                    this.getTotalAttack(),
                    this.currentEnemy.defense
                );

                if (playerDamage.miss) {
                    this.addBattleLog('–í—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª–∏—Å—å!', 'miss');
                } else {
                    this.currentEnemy.currentHP -= playerDamage.value;
                    const msg = playerDamage.critical ? 
                        `–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†! –í—ã –Ω–∞–Ω–µ—Å–ª–∏ ${playerDamage.value} —É—Ä–æ–Ω–∞!` :
                        `–í—ã –Ω–∞–Ω–µ—Å–ª–∏ ${playerDamage.value} —É—Ä–æ–Ω–∞`;
                    this.addBattleLog(msg, playerDamage.critical ? 'critical' : 'damage');
                }

                if (this.currentEnemy.currentHP <= 0) {
                    this.victory();
                    return;
                }

                setTimeout(() => this.enemyAttack(), 800);
                this.updateBattleUI();
            }

            enemyAttack() {
                const enemyDamage = this.calculateDamage(
                    this.currentEnemy.attack,
                    this.getTotalDefense()
                );

                if (enemyDamage.miss) {
                    this.addBattleLog(`${this.currentEnemy.name} –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è!`, 'miss');
                } else {
                    this.player.currentHP -= enemyDamage.value;
                    const msg = enemyDamage.critical ?
                        `–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†! ${this.currentEnemy.name} –Ω–∞–Ω–µ—Å ${enemyDamage.value} —É—Ä–æ–Ω–∞!` :
                        `${this.currentEnemy.name} –Ω–∞–Ω–µ—Å ${enemyDamage.value} —É—Ä–æ–Ω–∞`;
                    this.addBattleLog(msg, enemyDamage.critical ? 'critical' : 'damage');
                }

                if (this.player.currentHP <= 0) {
                    this.defeat();
                }

                this.updateBattleUI();
            }

            calculateDamage(attack, defense) {
                let damage = {
                    value: 0,
                    critical: false,
                    miss: false
                };

                if (this.engine.rollMiss()) {
                    damage.miss = true;
                    return damage;
                }

                const baseDamage = Math.max(1, attack - defense);
                const variance = this.engine.randomFloat(0.85, 1.15);
                damage.value = Math.floor(baseDamage * variance);

                if (this.engine.rollCritical()) {
                    damage.critical = true;
                    damage.value = Math.floor(damage.value * this.engine.randomFloat(1.8, 2.5));
                }

                this.engine.executeExtensions('onDamageCalculation', damage);

                return damage;
            }

            victory() {
                this.inBattle = false;
                this.addBattleLog(`–ü–æ–±–µ–¥–∞! ${this.currentEnemy.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`, 'victory');
                
                const xpGained = Math.floor(50 * Math.pow(1.1, this.currentEnemy.level - 1));
                const goldGained = this.engine.random(10, 30) * this.currentEnemy.level;
                
                this.player.xp += xpGained;
                this.player.gold += goldGained;
                this.player.totalKills++;
                
                this.addBattleLog(`–ü–æ–ª—É—á–µ–Ω–æ ${xpGained} –æ–ø—ã—Ç–∞ –∏ ${goldGained} –∑–æ–ª–æ—Ç–∞`, 'victory');

                if (this.engine.random(1, 100) <= 40) {
                    const loot = this.generateLoot();
                    this.player.inventory.push(loot);
                    this.addBattleLog(`–ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥–º–µ—Ç: ${loot.name} (${GameData.rarities[loot.rarity].name})`, 'victory');
                }

                while (this.player.xp >= this.player.xpToNext) {
                    this.levelUp();
                }

                this.engine.executeExtensions('afterBattle', { victory: true, enemy: this.currentEnemy });
                
                this.savePlayer();
                this.updateUI();
                this.updateBattleUI();

                setTimeout(() => {
                    this.switchScreen('worldScreen');
                    this.updateWorldScreen();
                }, 2000);
            }

            defeat() {
                this.inBattle = false;
                this.addBattleLog('–í—ã –ø–æ–≥–∏–±–ª–∏...', 'defeat');
                this.player.totalDeaths++;
                
                const metaPointsGained = Math.floor(this.player.level / 10) + 1;
                this.player.metaPoints += metaPointsGained;
                
                this.engine.executeExtensions('afterBattle', { victory: false, enemy: this.currentEnemy });
                
                this.savePlayer();
                
                setTimeout(() => {
                    this.showDeathScreen(metaPointsGained);
                }, 1500);
            }

            showDeathScreen(metaPoints) {
                const content = document.querySelector('#worldScreen .content');
                content.innerHTML = `
                    <div class="death-screen">
                        <h2>üíÄ –°–ú–ï–†–¢–¨ üíÄ</h2>
                        <div class="death-stats">
                            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
                            <p>–î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å: <strong>${this.player.level}</strong></p>
                            <p>–£–±–∏—Ç–æ –≤—Ä–∞–≥–æ–≤: <strong>${this.player.totalKills}</strong></p>
                            <p>–ù–∞–∫–æ–ø–ª–µ–Ω–æ –∑–æ–ª–æ—Ç–∞: <strong>${this.player.gold}</strong></p>
                        </div>
                        <div class="meta-progress">
                            <h3>–ú–µ—Ç–∞-–ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                            <p>–ü–æ–ª—É—á–µ–Ω–æ –æ—á–∫–æ–≤: <strong style="color: #ffd700;">+${metaPoints}</strong></p>
                            <p>–í—Å–µ–≥–æ –æ—á–∫–æ–≤: <strong>${this.player.metaPoints}</strong></p>
                            <p style="margin-top: 15px; font-size: 14px; color: #888;">
                                –ü–æ—Ç—Ä–∞—Ç—å—Ç–µ –æ—á–∫–∏ –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ–º!
                            </p>
                            <button class="btn" onclick="game.spendMetaPoints('attack')" style="margin-top: 10px;">
                                +1 –ê—Ç–∞–∫–∞ (1 –æ—á–∫–æ)
                            </button>
                            <button class="btn" onclick="game.spendMetaPoints('defense')">
                                +1 –ó–∞—â–∏—Ç–∞ (1 –æ—á–∫–æ)
                            </button>
                            <button class="btn" onclick="game.spendMetaPoints('hp')">
                                +10 HP (1 –æ—á–∫–æ)
                            </button>
                        </div>
                        <button class="btn" onclick="game.respawn()" style="margin-top: 20px; background: linear-gradient(135deg, #51cf66 0%, #2f9e44 100%);">
                            ‚öîÔ∏è –í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è
                        </button>
                    </div>
                `;
                this.switchScreen('worldScreen');
            }

            spendMetaPoints(type) {
                if (this.player.metaPoints <= 0) {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!');
                    return;
                }

                this.player.metaPoints--;
                
                if (type === 'attack') {
                    this.player.metaBonus.attack++;
                } else if (type === 'defense') {
                    this.player.metaBonus.defense++;
                } else if (type === 'hp') {
                    this.player.metaBonus.hp += 10;
                }

                this.savePlayer();
                this.showDeathScreen(0);
            }

            respawn() {
                if (this.player.level > this.player.highestLevel) {
                    this.player.highestLevel = this.player.level;
                    this.updateLeaderboard();
                }

                this.player.level = 1;
                this.player.xp = 0;
                this.player.xpToNext = 100;
                this.player.maxHP = 100 + this.player.metaBonus.hp;
                this.player.currentHP = this.player.maxHP;
                this.player.baseAttack = 10;
                this.player.baseDefense = 5;
                this.player.gold = 0;
                this.player.inventory = [];
                this.player.equipped = { weapon: null, armor: null };
                
                this.savePlayer();
                this.updateUI();
                
                const content = document.querySelector('#worldScreen .content');
                content.innerHTML = `
                    <h2 style="margin-bottom: 20px;">–ú–∏—Ä</h2>
                    <div style="background: rgba(30, 30, 45, 0.8); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3>–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è: <span id="currentLocation">–¢–µ–º–Ω—ã–π –ª–µ—Å</span></h3>
                        <p style="margin-top: 10px; color: #aaa;">–£—Ä–æ–≤–µ–Ω—å: <span id="worldLevel">1</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="worldProgress" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <button class="btn" onclick="game.startBattle()">‚öîÔ∏è –ù–∞—á–∞—Ç—å –±–æ–π</button>
                    <button class="btn btn-secondary" onclick="game.rest()">üèïÔ∏è –û—Ç–¥–æ—Ö–Ω—É—Ç—å (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å HP)</button>
                `;
                
                this.updateWorldScreen();
            }

            flee() {
                if (this.engine.random(1, 100) <= 50) {
                    this.addBattleLog('–í–∞–º —É–¥–∞–ª–æ—Å—å —Å–±–µ–∂–∞—Ç—å!', 'info');
                    this.inBattle = false;
                    setTimeout(() => {
                        this.switchScreen('worldScreen');
                    }, 1000);
                } else {
                    this.addBattleLog('–ü–æ–±–µ–≥ –Ω–µ —É–¥–∞–ª—Å—è!', 'miss');
                    setTimeout(() => this.enemyAttack(), 800);
                }
            }

            levelUp() {
                this.player.level++;
                this.player.xp -= this.player.xpToNext;
                this.player.xpToNext = Math.floor(this.player.xpToNext * 1.15);
                
                const hpGain = this.engine.random(8, 15);
                const attackGain = this.engine.random(2, 4);
                const defenseGain = this.engine.random(1, 3);
                
                this.player.maxHP += hpGain;
                this.player.currentHP += hpGain;
                this.player.baseAttack += attackGain;
                this.player.baseDefense += defenseGain;
                
                this.addBattleLog(`–ü–û–í–´–®–ï–ù–ò–ï –£–†–û–í–ù–Ø! –¢–µ–ø–µ—Ä—å –≤—ã ${this.player.level} —É—Ä–æ–≤–Ω—è!`, 'victory');
                this.addBattleLog(`HP +${hpGain}, –ê—Ç–∞–∫–∞ +${attackGain}, –ó–∞—â–∏—Ç–∞ +${defenseGain}`, 'victory');
                
                this.engine.executeExtensions('onLevelUp', this.player);
            }

            generateLoot() {
                const roll = Math.random();
                let rarity = 'common';
                
                for (const [key, data] of Object.entries(GameData.rarities)) {
                    if (roll <= data.dropChance) {
                        rarity = key;
                        break;
                    }
                }

                const isWeapon = Math.random() < 0.5;
                const template = isWeapon ?
                    GameData.weapons[this.engine.random(0, GameData.weapons.length - 1)] :
                    GameData.armor[this.engine.random(0, GameData.armor.length - 1)];

                const item = {
                    name: template.name,
                    rarity: rarity,
                    level: this.player.level
                };

                if (isWeapon) {
                    item.attack = Math.floor(
                        this.engine.calculateScaling(template.baseAttack, this.player.level, 1.05) *
                        GameData.rarities[rarity].statMult
                    );
                } else {
                    item.defense = Math.floor(
                        this.engine.calculateScaling(template.baseDefense, this.player.level, 1.05) *
                        GameData.rarities[rarity].statMult
                    );
                }

                return item;
            }

            updateBattleUI() {
                document.getElementById('battlePlayerName').textContent = this.player.nickname;
                document.getElementById('battlePlayerHPText').textContent = `${this.player.currentHP}/${this.player.maxHP}`;
                document.getElementById('battlePlayerHP').style.width = (this.player.currentHP / this.player.maxHP * 100) + '%';
                document.getElementById('battlePlayerAttack').textContent = this.getTotalAttack();
                document.getElementById('battlePlayerDefense').textContent = this.getTotalDefense();

                if (this.currentEnemy) {
                    document.getElementById('battleEnemyName').textContent = `${this.currentEnemy.name} (—É—Ä. ${this.currentEnemy.level})`;
                    document.getElementById('battleEnemyHPText').textContent = `${Math.max(0, this.currentEnemy.currentHP)}/${this.currentEnemy.maxHP}`;
                    document.getElementById('battleEnemyHP').style.width = (Math.max(0, this.currentEnemy.currentHP) / this.currentEnemy.maxHP * 100) + '%';
                    document.getElementById('battleEnemyAttack').textContent = this.currentEnemy.attack;
                    document.getElementById('battleEnemyDefense').textContent = this.currentEnemy.defense;
                }

                document.getElementById('attackBtn').disabled = !this.inBattle;
                document.getElementById('fleeBtn').disabled = !this.inBattle;
            }

            addBattleLog(message, type = 'info') {
                const log = document.getElementById('battleLog');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }
        }

        // ==================== INITIALIZE GAME ====================
        const game = new Game();

        // Check for saved player
        window.addEventListener('load', () => {
            const savedData = localStorage.getItem('eternalDarknessPlayer');
            if (savedData) {
                // Auto-login not implemented for security - user must login
            }
        });
    </script>
</body>
</html>
